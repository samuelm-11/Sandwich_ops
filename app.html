<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Sandwich Ops</title>

  <style>
    :root { --pad: 14px; --border:#eee; --text:#111; --muted:rgba(17,17,17,.7); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fff; color:var(--text); }
    * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
    button, .btn, .pill, .navitem, .smallbtn, .mini { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    body { -webkit-user-select:none; user-select:none; }
    input, textarea, select { -webkit-user-select:text; user-select:text; }

    header{
      position: sticky; top:0; background:#fff; border-bottom:1px solid var(--border);
      padding: var(--pad); z-index: 5; display:flex; align-items:center; gap:10px;
    }
    h1 { font-size: 18px; margin:0; flex:1; }
    .muted { opacity:.7; font-size:13px; color:var(--text); }

    main { padding: var(--pad); max-width: 820px; margin: 0 auto; }

    .drawerOverlay { position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:20; display:none; }
    .drawer {
      position:fixed; left:0; top:0; bottom:0; width:300px; max-width:86vw;
      background:#fff; border-right:1px solid var(--border); z-index:21;
      transform: translateX(-100%); transition: transform .18s ease;
      padding: 12px; display:flex; flex-direction:column; gap:10px;
    }
    .drawer.open { transform: translateX(0); }
    .drawerOverlay.open { display:block; }

    .navtitle { font-weight:900; font-size:14px; margin-top:6px; }
    .navitem {
      width:100%; text-align:left; padding:12px; border-radius:14px;
      border:1px solid #ddd; background:#fff; font-weight:900; font-size:15px;
    }
    .navitem.active { background:#111; color:#fff; border-color:#111; }

    /* D√©connexion (PAS navitem) */
    #logoutBtn{
      width:100%; text-align:left; padding:12px; border-radius:14px;
      border:1px solid #fcc; background:#fff8f8; color:#c00;
      font-weight:900; font-size:15px;
      touch-action: manipulation; -webkit-user-select:none; user-select:none;
    }

    .iconbtn { width:44px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; font-weight:900; }

    .card { padding: 12px; border:1px solid var(--border); border-radius: 14px; margin-top: 12px; }
    .row { display:flex; align-items:center; justify-content:space-between; padding: 12px; border:1px solid var(--border); border-radius: 14px; margin-bottom: 10px; gap:10px; }
    .name { font-weight: 900; }
    .sub { opacity:.7; font-size: 13px; margin-top:2px; }
    .qty { display:flex; align-items:center; gap:10px; }
    .btn { width: 46px; height: 40px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-size: 20px; font-weight: 900; }
    .qnum { min-width: 34px; text-align:center; font-size: 18px; font-weight: 900; }

    .kv { display:flex; justify-content:space-between; margin-top: 6px; }
    .cta { width:100%; padding: 14px; border-radius: 14px; border:none; background:#111; color:#fff; font-weight: 900; font-size: 16px; margin-top: 12px; }
    .cta:disabled { background:#888; }
    .smallbtn { padding: 10px 12px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-weight:900; }
    .mini { padding: 8px 10px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-weight:900; font-size:13px; }

    input[type="date"], input[type="datetime-local"], select, input[type="number"], input[type="text"] {
      font-size: 16px; padding: 10px 12px; border-radius: 12px; border:1px solid #ddd;
    }
    .field { display:flex; flex-direction:column; gap:6px; }
    .label { font-size: 12px; color: var(--muted); font-weight:700; }

    .pillrow { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px 0; }
    .pill { padding: 10px 14px; border-radius: 999px; border:1px solid #ddd; background:#fff; font-weight:900; }
    .pill.active { background:#111; color:#fff; border-color:#111; }

    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 6px; text-align:left; font-size: 14px; vertical-align:top; }
    th { font-weight: 900; }
    tfoot td { font-weight:900; border-top: 2px solid #ddd; }

    .spacer { height:8px; }

    .section { display:none; }
    .section.active { display:block; }

    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .grid3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
    @media (max-width: 720px){
      .grid2 { grid-template-columns: 1fr; }
      .grid3 { grid-template-columns: 1fr; }
    }

    .badgeOff { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; opacity:.7; }
  </style>
</head>

<body>

  <!-- Drawer -->
  <div class="drawerOverlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div style="display:flex; align-items:center; gap:10px;">
      <div style="font-weight:900; font-size:16px;">Sandwich Ops</div>
      <div style="flex:1;"></div>
      <button class="iconbtn" id="closeDrawer" type="button">‚úï</button>
    </div>

    <div class="navtitle">Navigation</div>

    <button class="navitem" data-tab="today" type="button">Aujourd'hui</button>
    <button class="navitem" data-tab="delivery" type="button">Livraison</button>
    <button class="navitem" data-tab="withdraw" type="button">√Ä retirer</button>
    <button class="navitem" data-tab="history" type="button">Historique</button>
    <button class="navitem" data-tab="settings" type="button">Param√®tres</button>
    <button class="navitem" data-tab="expenses" type="button">D√©penses</button>
    <button class="navitem" data-tab="results" type="button">R√©sultats</button>

    <!-- ‚úÖ AJOUT -->
    <button class="navitem" data-tab="shiftkm" type="button">KM & Shifts</button>

    <div style="flex:1;"></div>

    <button id="logoutBtn" type="button">‚éã D√©connexion</button>

    <div class="muted">
      Astuce: change la date, choisis le lieu, "Charger depuis Supabase", modifie, puis "Enregistrer ce lieu".
    </div>
  </aside>

  <header>
    <button class="iconbtn" id="openDrawer" type="button">‚ò∞</button>
    <h1 id="title">Aujourd'hui</h1>
    <div class="muted" id="status"></div>
  </header>

  <main>
    <!-- TODAY -->
    <section class="section active" id="tab-today">
      <!-- ... (inchang√©) ... -->
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Jour :</div>
        <input type="date" id="dayDate" />
        <button class="smallbtn" id="todayRefresh" type="button">Rafra√Æchir</button>
      </div>

      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900;">√Ä PRODUIRE (jour s√©lectionn√©)</div>
        <div class="muted">Bas√© sur ce qui est enregistr√© dans Supabase (deliveries).</div>
        <div class="spacer"></div>
        <div class="kv"><div>Total pi√®ces</div><div id="todayPieces" style="font-weight:900;">0</div></div>
        <div class="kv"><div>Total ‚Ç¨</div><div id="todayEur" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div class="muted" style="margin-top:8px;">DLC 2 jours ‚Üí Retrait √† partir de J+3 (ex: fait le 18 ‚Üí retirer le 21)</div>
        <div id="todayTable"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;">Encoder rapidement</div>
        <div class="muted">Choisis un lieu ‚Üí tu arrives sur Livraison (m√™me date).</div>
        <div class="pillrow" id="quickLocPills"></div>
      </div>

      <div class="card">
        <div style="font-weight:900;">√Ä retirer aujourd'hui (r√©sum√©)</div>
        <div class="muted">Bas√© sur la vue v_delivery_remaining (Supabase).</div>
        <div class="spacer"></div>
        <div id="todayWithdrawSummary" class="muted">‚Äî</div>
        <div class="spacer"></div>
        <button class="smallbtn" id="gotoWithdraw" type="button">G√©rer les retraits</button>
      </div>
    </section>

    <!-- DELIVERY -->
    <section class="section" id="tab-delivery">
      <!-- ... (inchang√©) ... -->
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Jour :</div>
        <input type="date" id="delDate" />
        <button class="smallbtn" id="loadFromDBBtn" type="button">Charger depuis Supabase</button>
      </div>

      <div class="pillrow" id="locationPills"></div>

      <label class="muted" style="display:flex; align-items:center; gap:10px; margin:8px 0;">
        <input type="checkbox" id="hideZeros" checked /> Masquer les produits √† 0
      </label>

      <div id="deliveryList"></div>

      <div class="card">
        <div class="kv"><div>Total pi√®ces</div><div id="delTotalPieces" style="font-weight:900;">0</div></div>
        <div class="kv"><div>Total ‚Ç¨</div><div id="delTotalEur" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div class="muted" style="margin-top:8px;">Enregistrer ce lieu = remplace (jour + lieu) en base (anti-doublon).</div>
      </div>

      <button class="cta" id="saveLocationBtn" type="button">Enregistrer ce lieu</button>
    </section>

    <!-- WITHDRAW -->
    <section class="section" id="tab-withdraw">
      <!-- ... (inchang√©) ... -->
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Date :</div>
        <input type="date" id="withdrawDate" />
        <button class="smallbtn" id="refreshWithdraw" type="button">Rafra√Æchir</button>
      </div>

      <div style="display:flex; gap:8px; margin-top:10px;">
        <button class="smallbtn" id="btnWithdrawAll" type="button">Tout retirer</button>
        <button class="smallbtn" id="btnWithdrawNone" type="button">Rien retirer</button>
      </div>

      <div id="withdrawList"></div>
      <button class="cta" id="saveWithdrawBtn" type="button">Enregistrer les retraits</button>
    </section>

    <!-- HISTORY -->
    <section class="section" id="tab-history">
      <!-- ... (inchang√©) ... -->
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Du :</div><input type="date" id="histFrom" />
        <div class="muted">Au :</div><input type="date" id="histTo" />
        <button class="smallbtn" id="refreshHist" type="button">Filtrer</button>
      </div>

      <div class="card">
        <div class="kv"><div>Livr√© (pi√®ces)</div><div id="histDelivered" style="font-weight:900;">0</div></div>
        <div class="kv"><div>Retir√© (pi√®ces)</div><div id="histWithdrawn" style="font-weight:900;">0</div></div>
        <div class="kv"><div>CA livr√©</div><div id="histRevenue" style="font-weight:900;">0,00‚Ç¨</div></div>
      </div>

      <div id="histList"></div>
    </section>

    <!-- SETTINGS -->
    <section class="section" id="tab-settings">
      <!-- ... (inchang√©) ... -->
      <div class="card">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
          <div style="font-weight:900;">Param√®tres</div>
          <div style="flex:1;"></div>
          <button class="mini" id="btnReloadAll" type="button">Recharger</button>
        </div>
        <div class="muted">Ici tu g√®res: DLC / J+ retrait + lieux + sandwichs (activer/d√©sactiver, ordre, prix).</div>
      </div>

      <div class="card">
        <div style="font-weight:900; margin-bottom:6px;">DLC & Retrait</div>
        <div class="row" style="margin-bottom:0;">
          <div><div class="name">DLC</div><div class="sub">En jours</div></div>
          <div><input type="number" id="setDlc" value="2" style="width:110px;"></div>
        </div>
        <div class="row" style="margin-top:10px;">
          <div><div class="name">Retrait √† partir de</div><div class="sub">J + ‚Ä¶</div></div>
          <div><input type="number" id="setWithdrawJ" value="3" style="width:110px;"></div>
        </div>
        <button class="cta" id="saveSettings" type="button">Sauvegarder (local)</button>
      </div>

      <div class="grid2">
        <div class="card">
          <div style="font-weight:900;">Ajouter un lieu</div>
          <div class="spacer"></div>
          <input id="newLocName" type="text" placeholder="Nom du lieu (ex: Avia)" />
          <div class="spacer"></div>
          <input id="newLocSort" type="number" placeholder="Ordre (ex: 10)" />
          <button class="cta" id="btnAddLoc" type="button">Ajouter lieu</button>

          <div class="spacer"></div>
          <div style="font-weight:900;">Lieux (actifs & inactifs)</div>
          <div class="muted">Tu peux modifier nom/ordre et activer/d√©sactiver.</div>
          <div class="spacer"></div>
          <div id="settingsLocList" class="muted">‚Äî</div>
        </div>

        <div class="card">
          <div style="font-weight:900;">Ajouter un sandwich</div>
          <div class="spacer"></div>
          <input id="newProdName" type="text" placeholder="Nom (ex: Merguez)" />
          <div class="spacer"></div>
          <input id="newProdPrice" type="text" placeholder="Prix ‚Ç¨ (ex: 6,50)" />
          <div class="spacer"></div>
          <input id="newProdSort" type="number" placeholder="Ordre (ex: 10)" />
          <button class="cta" id="btnAddProd" type="button">Ajouter sandwich</button>

          <div class="spacer"></div>
          <div style="font-weight:900;">Sandwichs (actifs & inactifs)</div>
          <div class="muted">Modifier nom/prix/ordre et activer/d√©sactiver.</div>
          <div class="spacer"></div>
          <div id="settingsProdList" class="muted">‚Äî</div>
        </div>
      </div>
    </section>

    <!-- EXPENSES -->
    <section class="section" id="tab-expenses">
      <!-- ... (inchang√©) ... -->
      <div class="card">
        <div style="font-weight:900;">Ajouter une d√©pense</div>
        <div class="muted">Scan facultatif (photo souche) ‚Üí stock√© dans Supabase Storage (bucket: receipts).</div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
          <label class="field"><div class="label">Date</div><input type="date" id="expDate" /></label>
          <label class="field"><div class="label">Montant (‚Ç¨)</div><input type="text" inputmode="decimal" placeholder="ex: 12,50" id="expAmount" /></label>

          <label class="field">
            <div class="label">Cat√©gorie</div>
            <select id="expCategory">
              <option value="Parking">Parking</option>
              <option value="Essence">Essence</option>
              <option value="Emballages">Emballages</option>
              <option value="Ingr√©dients">Ingr√©dients</option>
              <option value="Mat√©riel">Mat√©riel</option>
              <option value="Divers">Divers</option>
            </select>
          </label>

          <label class="field"><div class="label">Note (optionnel)</div><input type="text" placeholder="ex: parking 2h / facture Metro‚Ä¶" id="expNote" /></label>
          <label class="field" style="grid-column:1 / -1;"><div class="label">Scan / photo (optionnel)</div><input type="file" id="expReceipt" accept="image/*" /></label>
        </div>

        <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
          <button class="smallbtn" id="addExpenseBtn" type="button">Ajouter</button>
          <button class="smallbtn" id="clearExpenseFormBtn" type="button">Vider</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:900;">Journal des d√©penses</div>
        <div class="muted">Filtre par dates (par d√©faut : 30 derniers jours).</div>

        <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
          <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="expFrom" /></label>
          <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="expTo" /></label>
          <button class="smallbtn" id="refreshExpenses" type="button">Rafra√Æchir</button>
        </div>

        <div class="spacer"></div>
        <div class="kv"><div>Total p√©riode</div><div id="expTotal" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div id="expList" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- RESULTS -->
    <section class="section" id="tab-results">
      <!-- ... (inchang√©) ... -->
      <div class="card">
        <div style="font-weight:900;">R√©sultats (CA ‚Äì D√©penses)</div>
        <div class="muted">Bas√© sur deliveries (CA) et expenses (d√©penses).</div>

        <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
          <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="resFrom" /></label>
          <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="resTo" /></label>
          <button class="smallbtn" id="refreshResults" type="button">Calculer</button>
        </div>

        <div class="spacer"></div>
        <div class="kv"><div>CA (livraisons)</div><div id="resCA" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div class="kv"><div>D√©penses</div><div id="resExp" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div class="kv"><div>B√©n√©fice net</div><div id="resNet" style="font-weight:900;">0,00‚Ç¨</div></div>
        <div class="muted" style="margin-top:10px;" id="resPieces">‚Äî</div>
        <div id="resByCategory" style="margin-top:10px;"></div>
      </div>
    </section>

    <!-- ‚úÖ NOUVEL ONGLET : KM & SHIFTS -->
    <section class="section" id="tab-shiftkm">
      <div class="card">
        <div style="font-weight:900;">Ajouter un shift</div>
        <div class="muted">Enregistre dans la table <b>shifts</b> (start_ts / end_ts).</div>
        <div class="spacer"></div>

        <div class="grid3">
          <label class="field">
            <div class="label">D√©but</div>
            <input type="datetime-local" id="shiftStart">
          </label>

          <label class="field">
            <div class="label">Fin</div>
            <input type="datetime-local" id="shiftEnd">
          </label>

          <label class="field">
            <div class="label">Note (optionnel)</div>
            <input type="text" id="shiftNote" placeholder="ex: tourn√©e Avia/Bierset">
          </label>
        </div>

        <button class="cta" id="addShiftBtn" type="button">Ajouter shift</button>
      </div>

      <div class="card">
        <div style="font-weight:900;">Ajouter KM</div>
        <div class="muted">Enregistre dans <b>km_logs</b> (day / odo_start / odo_end).</div>
        <div class="spacer"></div>

        <div class="grid3">
          <label class="field">
            <div class="label">Jour</div>
            <input type="date" id="kmDay">
          </label>

          <label class="field">
            <div class="label">Compteur d√©but</div>
            <input type="number" id="kmStart" placeholder="ex: 81234">
          </label>

          <label class="field">
            <div class="label">Compteur fin</div>
            <input type="number" id="kmEnd" placeholder="ex: 81295">
          </label>
        </div>

        <div class="spacer"></div>
        <input type="text" id="kmNote" placeholder="Note (optionnel)">
        <button class="cta" id="addKmBtn" type="button">Ajouter KM</button>
      </div>

      <div class="card">
        <div style="font-weight:900;">R√©sum√© (30 derniers jours)</div>
        <div class="muted">Heures = somme des shifts ¬∑ KM = somme (odo_end - odo_start).</div>
        <div class="spacer"></div>
        <div id="shiftKmSummary" class="muted">‚Äî</div>
        <button class="smallbtn" id="refreshShiftKmBtn" type="button" style="margin-top:10px;">Rafra√Æchir</button>
      </div>
    </section>

  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const SUPABASE_URL = "https://frbofmnvfvzrtefwhdyo.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZyYm9mbW52ZnZ6cnRlZndoZHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE0MzAxNzMsImV4cCI6MjA4NzAwNjE3M30.LgDTq7ncaclByUYi3FYr6LwFBpUFIbamKixmkv2U7HU";
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // üîê Protection page
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) { window.location.href = "./index.html"; throw new Error("Not authenticated"); }

    const $ = (id) => document.getElementById(id);
    const status = $("status");
    function setStatus(msg) { status.textContent = msg || ""; }
    function eur(cents) { return (Number(cents || 0) / 100).toFixed(2).replace(".", ",") + "‚Ç¨"; }
    function isoDate(d = new Date()) { return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10); }
    function isoDTLocalNowMinusTZ(d = new Date()){
      // yyyy-MM-ddTHH:mm (local)
      const x = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return x.toISOString().slice(0,16);
    }
    function addDaysISO(baseISO, days) { const d = new Date(baseISO + "T00:00:00"); d.setDate(d.getDate() + days); return isoDate(d); }
    function toInt(v, def=0){ const n = parseInt(String(v ?? "").trim(), 10); return Number.isFinite(n) ? n : def; }
    function toEuroStringToCents(v){ const n = Number(String(v ?? "").trim().replace(",", ".")); if (!Number.isFinite(n)) return null; return Math.round(n * 100); }
    function esc(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"','&quot;'); }

    // ‚úÖ D√©connexion
    $("logoutBtn").onclick = async () => {
      if (!confirm("Se d√©connecter ?")) return;
      await supabase.auth.signOut();
      window.location.href = "./index.html";
    };

    function loadSettings() {
      const raw = localStorage.getItem("sandops:settings");
      const def = { dlc:2, withdrawJ:3 };
      const s = raw ? { ...def, ...JSON.parse(raw) } : def;
      $("setDlc").value = String(s.dlc);
      $("setWithdrawJ").value = String(s.withdrawJ);
      return s;
    }
    function saveSettingsLocal() {
      const s = { dlc: Number($("setDlc").value||2), withdrawJ: Number($("setWithdrawJ").value||3) };
      localStorage.setItem("sandops:settings", JSON.stringify(s));
      alert("Param√®tres sauvegard√©s ‚úÖ");
    }

    // Drawer open/close
    const drawer = $("drawer");
    const overlay = $("drawerOverlay");
    const title = $("title");

    function lockScroll(on){
      document.body.style.overflow = on ? "hidden" : "";
      document.documentElement.style.overflow = on ? "hidden" : "";
    }
    function openDrawer() {
      drawer.classList.add("open");
      overlay.classList.add("open");
      lockScroll(true);
    }
    function closeDrawer() {
      drawer.classList.remove("open");
      overlay.classList.remove("open");
      lockScroll(false);
    }
    $("openDrawer").onclick = openDrawer;
    $("closeDrawer").onclick = closeDrawer;
    overlay.onclick = closeDrawer;

    // ‚úÖ Navigation
    const navitems = Array.from(document.querySelectorAll('.navitem[data-tab]'));
    const sections = {
      today: $("tab-today"),
      delivery: $("tab-delivery"),
      withdraw: $("tab-withdraw"),
      history: $("tab-history"),
      settings: $("tab-settings"),
      expenses: $("tab-expenses"),
      results: $("tab-results"),
      shiftkm: $("tab-shiftkm"), // ‚úÖ AJOUT
    };

    function goTab(tab) {
      closeDrawer();
      navitems.forEach(b => b.classList.remove("active"));
      document.querySelector(`.navitem[data-tab="${tab}"]`)?.classList.add("active");

      Object.entries(sections).forEach(([k, sec]) => sec.classList.toggle("active", k === tab));

      title.textContent = ({
        today:"Aujourd'hui",
        delivery:"Livraison",
        withdraw:"√Ä retirer",
        history:"Historique",
        expenses:"D√©penses",
        results:"R√©sultats",
        settings:"Param√®tres",
        shiftkm:"KM & Shifts",
      })[tab] || tab;

      if (tab === "shiftkm") refreshShiftKmSummary();
    }

    goTab("today");
    navitems.forEach(b => b.addEventListener("click", () => goTab(b.dataset.tab)));

    // ----------------------------
    // DATA / APP LOGIC (inchang√©)
    // ----------------------------
    let locations = [], products = [], locationId = "";
    let qtyByProduct = {}, withdrawQtyByDelivery = {}, remainingByDelivery = {}, lastDueList = null;

    function activeLocations(){ return locations.filter(l => l.is_active); }
    function activeProducts(){ return products.filter(p => p.is_active); }
    function resetQty() { qtyByProduct = {}; for (const p of activeProducts()) qtyByProduct[p.id] = 0; }

    $("dayDate").value = isoDate();
    $("delDate").value = isoDate();
    $("withdrawDate").value = isoDate();

    const today = isoDate();
    $("histFrom").value = addDaysISO(today, -30);
    $("histTo").value = today;

    $("expDate").value = isoDate();
    $("expFrom").value = addDaysISO(today, -30);
    $("expTo").value = today;

    $("resFrom").value = addDaysISO(today, -30);
    $("resTo").value = today;

    // ‚úÖ INIT KM/SHIFT inputs
    $("kmDay").value = isoDate();
    $("shiftStart").value = isoDTLocalNowMinusTZ();
    $("shiftEnd").value = isoDTLocalNowMinusTZ();
    $("refreshShiftKmBtn").onclick = refreshShiftKmSummary;

    // ----------------------------
    // ‚úÖ KM & SHIFTS (AJOUT)
    // ----------------------------
    $("addShiftBtn").onclick = addShift;
    $("addKmBtn").onclick = addKm;

    async function addShift() {
      const start = $("shiftStart").value;
      const end = $("shiftEnd").value;
      const note = ($("shiftNote").value || "").trim() || null;

      if (!start || !end) { alert("D√©but et fin obligatoires."); return; }

      const startISO = new Date(start).toISOString();
      const endISO   = new Date(end).toISOString();
      if (new Date(endISO) <= new Date(startISO)) { alert("La fin doit √™tre apr√®s le d√©but."); return; }

      setStatus("Ajout shift‚Ä¶");
      const res = await supabase.from("shifts").insert({ start_ts: startISO, end_ts: endISO, note });
      setStatus("");

      if (res.error) { alert("Erreur shift: " + res.error.message); return; }

      alert("Shift ajout√© ‚úÖ");
      $("shiftNote").value = "";
      await refreshShiftKmSummary();
    }

    async function addKm() {
      const day = $("kmDay").value || isoDate();
      const odo_start = parseInt($("kmStart").value, 10);
      const odo_end   = parseInt($("kmEnd").value, 10);
      const note = ($("kmNote").value || "").trim() || null;

      if (!day) { alert("Jour obligatoire."); return; }
      if (!Number.isFinite(odo_start) || !Number.isFinite(odo_end)) { alert("Compteurs invalides."); return; }
      if (odo_end < odo_start) { alert("odo_end doit √™tre >= odo_start."); return; }

      setStatus("Ajout KM‚Ä¶");
      const res = await supabase.from("km_logs").insert({ day, odo_start, odo_end, note });
      setStatus("");

      if (res.error) { alert("Erreur KM: " + res.error.message); return; }

      alert("KM ajout√© ‚úÖ");
      $("kmStart").value = "";
      $("kmEnd").value = "";
      $("kmNote").value = "";
      await refreshShiftKmSummary();
    }

    function fmtHours(mins){
      const h = mins / 60;
      return h.toFixed(1).replace(".", ",") + " h";
    }

    async function refreshShiftKmSummary() {
      const from = addDaysISO(isoDate(), -30);
      const to = isoDate();

      setStatus("Calcul KM/Shifts‚Ä¶");

      const shifts = await supabase
        .from("shifts")
        .select("start_ts,end_ts")
        .gte("start_ts", from + "T00:00:00Z")
        .lte("start_ts", to + "T23:59:59Z");

      const kms = await supabase
        .from("km_logs")
        .select("day,odo_start,odo_end")
        .gte("day", from)
        .lte("day", to);

      setStatus("");

      if (shifts.error) { $("shiftKmSummary").textContent = "Erreur shifts: " + shifts.error.message; return; }
      if (kms.error) { $("shiftKmSummary").textContent = "Erreur km_logs: " + kms.error.message; return; }

      let totalMinutes = 0;
      for (const s of (shifts.data || [])) {
        const a = new Date(s.start_ts);
        const b = new Date(s.end_ts);
        const mins = (b - a) / 60000;
        if (Number.isFinite(mins) && mins > 0) totalMinutes += mins;
      }

      let totalKm = 0;
      for (const k of (kms.data || [])) {
        const d = (Number(k.odo_end||0) - Number(k.odo_start||0));
        if (Number.isFinite(d) && d >= 0) totalKm += d;
      }

      $("shiftKmSummary").innerHTML = `
        <div class="kv"><div>Shifts (30j)</div><div style="font-weight:900;">${(shifts.data||[]).length}</div></div>
        <div class="kv"><div>Heures (30j)</div><div style="font-weight:900;">${fmtHours(totalMinutes)}</div></div>
        <div class="kv"><div>Trajets KM (30j)</div><div style="font-weight:900;">${(kms.data||[]).length}</div></div>
        <div class="kv"><div>Kilom√®tres (30j)</div><div style="font-weight:900;">${totalKm} km</div></div>
      `;
    }

    // ----------------------------
    // TON CODE RESTE IDENTIQUE CI-DESSOUS
    // (deliveries / withdraw / history / expenses / results / settings)
    // ----------------------------

    async function loadRefsFresh() {
      setStatus("Chargement produits/lieux‚Ä¶");
      const locRes = await supabase.from("locations").select("id,name,sort_order,is_active").order("sort_order", { ascending: true });
      const prodRes = await supabase.from("products").select("id,name,price_cents,sort_order,is_active").order("sort_order", { ascending: true });
      setStatus("");

      if (locRes.error) throw locRes.error;
      if (prodRes.error) throw prodRes.error;

      locations = (locRes.data || []).map(x => ({ ...x, is_active: !!x.is_active }));
      products  = (prodRes.data || []).map(x => ({ ...x, is_active: !!x.is_active }));

      const actLocs = activeLocations();
      if (!locationId || !actLocs.find(l => l.id === locationId)) locationId = actLocs[0]?.id || "";

      resetQty();
    }

    async function reloadAllData() {
      await loadRefsFresh();
      renderLocationPills();
      renderQuickPills();
      renderDeliveryList();
      updateDeliveryTotals();
      await refreshSettingsLists();
      await refreshToday();
      await refreshExpenses();
      await refreshResults();
    }

    function renderLocationPills() {
      const box = $("locationPills");
      box.innerHTML = "";

      const locs = activeLocations();
      if (!locs.length) { box.innerHTML = `<div class="muted">Aucun lieu actif. Va dans Param√®tres.</div>`; return; }

      locs.forEach(l => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "pill" + (l.id === locationId ? " active" : "");
        b.textContent = l.name;
        b.onclick = () => { locationId = l.id; renderLocationPills(); };
        box.appendChild(b);
      });
    }

    function renderQuickPills() {
      const box = $("quickLocPills");
      box.innerHTML = "";

      const locs = activeLocations();
      if (!locs.length) { box.innerHTML = `<div class="muted">Ajoute/active un lieu dans Param√®tres.</div>`; return; }

      locs.forEach(l => {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "pill";
        b.textContent = l.name;
        b.onclick = () => {
          $("delDate").value = $("dayDate").value || isoDate();
          locationId = l.id;
          renderLocationPills();
          goTab("delivery");
        };
        box.appendChild(b);
      });
    }

    function renderDeliveryList() {
      const hide = $("hideZeros").checked;
      const list = $("deliveryList");
      list.innerHTML = "";

      const prods = activeProducts().slice().sort((a,b)=> toInt(a.sort_order,9999)-toInt(b.sort_order,9999));
      if (!prods.length) { list.innerHTML = `<div class="muted">Aucun sandwich actif. Va dans Param√®tres.</div>`; return; }

      const visible = hide ? prods.filter(p => (qtyByProduct[p.id] || 0) > 0) : prods;
      const toShow = (visible.length === 0 && hide) ? prods : visible;

      toShow.forEach(p => {
        const q = qtyByProduct[p.id] || 0;
        const row = document.createElement("div");
        row.className = "row";
        row.innerHTML = `
          <div><div class="name">${esc(p.name)}</div><div class="sub">${eur(p.price_cents)}</div></div>
          <div class="qty"><button class="btn" type="button">‚àí</button><div class="qnum">${q}</div><button class="btn" type="button">+</button></div>
        `;
        const btns = row.querySelectorAll("button");
        btns[0].onclick = () => { qtyByProduct[p.id] = Math.max(0, q - 1); renderDeliveryList(); updateDeliveryTotals(); };
        btns[1].onclick = () => { qtyByProduct[p.id] = q + 1; renderDeliveryList(); updateDeliveryTotals(); };
        list.appendChild(row);
      });
    }

    function updateDeliveryTotals() {
      let pieces = 0, cents = 0;
      for (const p of activeProducts()) {
        const q = Number(qtyByProduct[p.id] || 0);
        pieces += q;
        cents += q * Number(p.price_cents || 0);
      }
      $("delTotalPieces").textContent = String(pieces);
      $("delTotalEur").textContent = eur(cents);
    }

    $("hideZeros").addEventListener("change", renderDeliveryList);

    async function loadDayLocationFromDB(dateISO, locId) {
      const res = await supabase
        .from("deliveries")
        .select("product_id, qty_depose")
        .eq("date_fabrication", dateISO)
        .eq("location_id", locId);

      if (res.error) { alert("Erreur chargement: " + res.error.message); return false; }

      resetQty();
      const activeIds = new Set(activeProducts().map(p => p.id));
      for (const r of (res.data || [])) {
        if (!activeIds.has(r.product_id)) continue;
        qtyByProduct[r.product_id] = (qtyByProduct[r.product_id] || 0) + Number(r.qty_depose || 0);
      }

      renderDeliveryList();
      updateDeliveryTotals();
      return true;
    }

    async function saveDayLocationToDB(dateISO, locId) {
      const s = loadSettings();
      const retrait = addDaysISO(dateISO, Number(s.withdrawJ || 3));

      const rows = activeProducts()
        .map(p => ({ product_id: p.id, qty: Number(qtyByProduct[p.id] || 0) }))
        .filter(x => x.qty > 0);

      setStatus("Enregistrement‚Ä¶");
      $("saveLocationBtn").disabled = true;

      const delOld = await supabase
        .from("deliveries")
        .delete()
        .eq("date_fabrication", dateISO)
        .eq("location_id", locId);

      if (delOld.error) {
        $("saveLocationBtn").disabled = false;
        setStatus("");
        alert("Erreur delete (RLS?) : " + delOld.error.message);
        return;
      }

      if (!rows.length) {
        $("saveLocationBtn").disabled = false;
        setStatus("");
        alert("Lieu mis √† 0 (enregistr√©) ‚úÖ");
        await refreshToday();
        return;
      }

      const payload = rows.map(r => ({
        date_fabrication: dateISO,
        date_retrait: retrait,
        location_id: locId,
        product_id: r.product_id,
        qty_depose: r.qty
      }));

      const ins = await supabase.from("deliveries").insert(payload);

      $("saveLocationBtn").disabled = false;
      setStatus("");

      if (ins.error) { alert("Erreur insert: " + ins.error.message); return; }

      alert("Enregistr√© ‚úÖ (jour + lieu remplac√©)");
      await refreshToday();
    }

    $("loadFromDBBtn").onclick = async () => {
      const d = $("delDate").value || isoDate();
      if (!locationId) { alert("Aucun lieu actif."); return; }
      await loadDayLocationFromDB(d, locationId);
    };

    $("saveLocationBtn").onclick = async () => {
      const d = $("delDate").value || isoDate();
      if (!locationId) { alert("Aucun lieu actif."); return; }
      await saveDayLocationToDB(d, locationId);
    };

    async function refreshToday() { await refreshTodayProductionOnly(); await refreshTodayWithdrawSummary(); }
    $("todayRefresh").onclick = refreshToday;

    async function refreshTodayProductionOnly() {
      const dateFab = $("dayDate").value || isoDate();
      setStatus("Calcul‚Ä¶");

      const res = await supabase
        .from("deliveries")
        .select("location_id, product_id, qty_depose")
        .eq("date_fabrication", dateFab);

      setStatus("");
      if (res.error) { alert("Erreur: " + res.error.message); return; }

      const locsSorted = activeLocations().slice().sort((a,b)=> toInt(a.sort_order,9999)-toInt(b.sort_order,9999));
      const prodsSorted = activeProducts().slice().sort((a,b)=> toInt(a.sort_order,9999)-toInt(b.sort_order,9999));

      const locById = Object.fromEntries(locsSorted.map(l => [l.id, l]));
      const prodById = Object.fromEntries(prodsSorted.map(p => [p.id, p]));

      const byProd = new Map();
      const locTotals = new Map();
      for (const l of locsSorted) locTotals.set(l.id, 0);

      for (const r of (res.data || [])) {
        const p = prodById[r.product_id];
        const l = locById[r.location_id];
        if (!p || !l) continue;

        const q = Number(r.qty_depose || 0);

        if (!byProd.has(p.id)) byProd.set(p.id, { product:p, perLoc:new Map(), totalQty:0, totalCents:0 });
        const g = byProd.get(p.id);

        g.perLoc.set(l.id, (g.perLoc.get(l.id) || 0) + q);
        g.totalQty += q;
        g.totalCents += q * Number(p.price_cents || 0);

        locTotals.set(l.id, (locTotals.get(l.id) || 0) + q);
      }

      let totalPieces = 0, totalCents = 0;
      for (const g of byProd.values()) { totalPieces += g.totalQty; totalCents += g.totalCents; }

      $("todayPieces").textContent = String(totalPieces);
      $("todayEur").textContent = eur(totalCents);

      if (!locsSorted.length || !prodsSorted.length) {
        $("todayTable").innerHTML = `<div class="muted" style="margin-top:10px;">Ajoute/active au moins 1 lieu et 1 sandwich dans Param√®tres.</div>`;
        return;
      }

      let html = `<table><thead><tr><th>Sandwich</th>${locsSorted.map(l=>`<th>${esc(l.name)}</th>`).join("")}<th>TOTAL</th></tr></thead><tbody>`;
      for (const p of prodsSorted) {
        const g = byProd.get(p.id);
        const t = g?.totalQty || 0;
        html += `<tr><td><b>${esc(p.name)}</b></td>${locsSorted.map(l=>`<td>${g?.perLoc.get(l.id)||0}</td>`).join("")}<td><b>${t}</b></td></tr>`;
      }
      html += `</tbody><tfoot><tr><td>TOTAL</td>${locsSorted.map(l=>`<td>${locTotals.get(l.id)||0}</td>`).join("")}<td>${totalPieces}</td></tr></tfoot></table>`;
      $("todayTable").innerHTML = html;
    }

    async function refreshTodayWithdrawSummary() {
      const todayISO = $("dayDate").value || isoDate();
      const v = await supabase.from("v_delivery_remaining").select("*");
      if (v.error) { $("todayWithdrawSummary").textContent = "Erreur: " + v.error.message; return; }

      const due = (v.data || []).filter(r => Number(r.qty_remaining||0) > 0 && String(r.date_retrait) <= todayISO);

      const byLoc = new Map();
      let total = 0;

      const locByIdAll = Object.fromEntries(locations.map(l => [l.id, l]));

      for (const r of due) {
        const k = r.location_id;
        const q = Number(r.qty_remaining||0);
        byLoc.set(k, (byLoc.get(k)||0)+q);
        total += q;
      }

      const lines = [];
      for (const [locId, q] of byLoc.entries()) {
        const name = locByIdAll[locId]?.name || locId;
        const active = locByIdAll[locId]?.is_active !== false;
        lines.push(`${esc(name)} : ${q} pi√®ce(s) ${active ? "" : '<span class="badgeOff">inactif</span>'}`);
      }

      lines.sort((a,b)=> a.localeCompare(b));
      $("todayWithdrawSummary").innerHTML = lines.length
        ? `${lines.join("<br>")}<br><br><b>Total √† retirer: ${total} pi√®ce(s)</b>`
        : `Rien √† retirer ‚úÖ`;
    }

    $("gotoWithdraw").onclick = () => {
      $("withdrawDate").value = $("dayDate").value || isoDate();
      goTab("withdraw");
      refreshWithdraw();
    };

    $("refreshWithdraw").onclick = refreshWithdraw;

    $("btnWithdrawAll").onclick = () => {
      if (!lastDueList) return;
      Object.keys(remainingByDelivery).forEach(id => withdrawQtyByDelivery[id] = remainingByDelivery[id]);
      renderWithdrawList(lastDueList);
    };

    $("btnWithdrawNone").onclick = () => {
      if (!lastDueList) return;
      Object.keys(withdrawQtyByDelivery).forEach(id => withdrawQtyByDelivery[id] = 0);
      renderWithdrawList(lastDueList);
    };

    $("saveWithdrawBtn").onclick = saveWithdrawals;

    async function refreshWithdraw() {
      setStatus("Chargement des lots √† retirer‚Ä¶");
      const todayISO = $("withdrawDate").value || isoDate();
      const v = await supabase.from("v_delivery_remaining").select("*");
      setStatus("");
      if (v.error) { alert("Erreur: " + v.error.message); return; }

      const prodByIdAll = Object.fromEntries(products.map(p => [p.id, p]));
      const locByIdAll  = Object.fromEntries(locations.map(l => [l.id, l]));

      const due = (v.data || [])
        .filter(r => Number(r.qty_remaining||0) > 0 && String(r.date_retrait) <= todayISO)
        .map(r => ({
          delivery_id: r.delivery_id,
          date_fabrication: r.date_fabrication,
          date_retrait: r.date_retrait,
          qty_remaining: Number(r.qty_remaining||0),
          product: prodByIdAll[r.product_id],
          location: locByIdAll[r.location_id]
        }))
        .filter(x => x.product && x.location)
        .sort((a,b) => {
          if (toInt(a.location.sort_order,9999) !== toInt(b.location.sort_order,9999)) return toInt(a.location.sort_order,9999)-toInt(b.location.sort_order,9999);
          if (toInt(a.product.sort_order,9999) !== toInt(b.product.sort_order,9999)) return toInt(a.product.sort_order,9999)-toInt(b.product.sort_order,9999);
          return String(a.date_fabrication).localeCompare(String(b.date_fabrication));
        });

      lastDueList = due;
      remainingByDelivery = {};
      withdrawQtyByDelivery = {};
      for (const d of due) { remainingByDelivery[d.delivery_id] = d.qty_remaining; withdrawQtyByDelivery[d.delivery_id] = 0; }
      renderWithdrawList(due);
    }

    function renderWithdrawList(dueList) {
      const list = $("withdrawList");
      list.innerHTML = "";
      if (!dueList || !dueList.length) {
        list.innerHTML = `<div class="card"><div style="font-weight:900;">Rien √† retirer ‚úÖ</div><div class="muted">Aucun lot arriv√© √† √©ch√©ance √† cette date.</div></div>`;
        return;
      }

      const byLoc = new Map();
      dueList.forEach(x => { const k = x.location.name; if (!byLoc.has(k)) byLoc.set(k, []); byLoc.get(k).push(x); });

      for (const [locName, items] of byLoc.entries()) {
        const t = document.createElement("div");
        t.style.fontWeight = "900";
        t.style.margin = "16px 0 8px 0";
        t.innerHTML = `${esc(locName)} ${items[0]?.location?.is_active ? "" : '<span class="badgeOff">inactif</span>'}`;
        list.appendChild(t);

        items.forEach(item => {
          const q = withdrawQtyByDelivery[item.delivery_id] || 0;
          const max = item.qty_remaining;

          const row = document.createElement("div");
          row.className = "row";
          row.innerHTML = `
            <div>
              <div class="name">${esc(item.product.name)} ${item.product.is_active ? "" : '<span class="badgeOff">inactif</span>'}</div>
              <div class="sub">Fab ${esc(item.date_fabrication)} ¬∑ √Ä retirer d√®s ${esc(item.date_retrait)} ¬∑ Reste: ${max}</div>
            </div>
            <div class="qty">
              <button class="btn" type="button">‚àí</button>
              <div class="qnum">${q}</div>
              <button class="btn" type="button">+</button>
            </div>
          `;
          const btns = row.querySelectorAll("button");
          btns[0].onclick = () => { withdrawQtyByDelivery[item.delivery_id] = Math.max(0, q-1); renderWithdrawList(dueList); };
          btns[1].onclick = () => { withdrawQtyByDelivery[item.delivery_id] = Math.min(max, q+1); renderWithdrawList(dueList); };
          list.appendChild(row);
        });
      }
    }

    async function saveWithdrawals() {
      const dateEff = $("withdrawDate").value || isoDate();
      const rows = Object.entries(withdrawQtyByDelivery).map(([delivery_id, qty_retire]) => ({ delivery_id, qty_retire: Number(qty_retire||0) })).filter(x => x.qty_retire > 0);
      if (!rows.length) { alert("Aucun retrait encod√© (tout est √† 0)."); return; }
      for (const r of rows) { if (r.qty_retire > (remainingByDelivery[r.delivery_id] ?? 0)) { alert("Retrait trop grand."); return; } }

      $("saveWithdrawBtn").disabled = true;
      setStatus("Enregistrement retraits‚Ä¶");

      const ins = await supabase.from("withdrawals").insert(rows.map(r => ({ date_retrait_effectif: dateEff, delivery_id: r.delivery_id, qty_retire: r.qty_retire })));

      $("saveWithdrawBtn").disabled = false;
      setStatus("");

      if (ins.error) { alert("Erreur: " + ins.error.message); return; }

      alert("Retraits enregistr√©s ‚úÖ");
      await refreshWithdraw();
      await refreshToday();
      await refreshHistory();
    }

    $("refreshHist").onclick = refreshHistory;

    async function refreshHistory() {
      const from = $("histFrom").value || addDaysISO(isoDate(), -30);
      const to = $("histTo").value || isoDate();

      setStatus("Chargement historique‚Ä¶");

      const del = await supabase.from("deliveries").select("date_fabrication, product_id, qty_depose").gte("date_fabrication", from).lte("date_fabrication", to);
      const wit = await supabase.from("withdrawals").select("date_retrait_effectif, qty_retire").gte("date_retrait_effectif", from).lte("date_retrait_effectif", to);

      setStatus("");

      if (del.error) { alert("Erreur deliveries: " + del.error.message); return; }
      if (wit.error) { alert("Erreur withdrawals: " + wit.error.message); return; }

      const prodByIdAll = Object.fromEntries(products.map(p => [p.id, p]));

      let deliveredPieces = 0, revenueCents = 0;
      for (const r of (del.data||[])) { deliveredPieces += Number(r.qty_depose||0); const p = prodByIdAll[r.product_id]; if (p) revenueCents += Number(r.qty_depose||0) * Number(p.price_cents||0); }

      let withdrawnPieces = 0;
      for (const r of (wit.data||[])) withdrawnPieces += Number(r.qty_retire||0);

      $("histDelivered").textContent = String(deliveredPieces);
      $("histWithdrawn").textContent = String(withdrawnPieces);
      $("histRevenue").textContent = eur(revenueCents);

      const byDate = new Map();
      for (const r of (del.data||[])) {
        const d = r.date_fabrication;
        if (!byDate.has(d)) byDate.set(d, { pieces:0, cents:0 });
        const p = prodByIdAll[r.product_id];
        byDate.get(d).pieces += Number(r.qty_depose||0);
        if (p) byDate.get(d).cents += Number(r.qty_depose||0)*Number(p.price_cents||0);
      }

      const dates = [...byDate.keys()].sort((a,b)=>b.localeCompare(a)).slice(0,12);
      let html = "";
      for (const d of dates) { const x = byDate.get(d); html += `<div class="row"><div><div class="name">${esc(d)}</div><div class="sub">${x.pieces} pi√®ces</div></div><div style="font-weight:900;">${eur(x.cents)}</div></div>`; }
      $("histList").innerHTML = html || `<div class="muted">Aucune donn√©e sur cette p√©riode.</div>`;
    }

    // EXPENSES (inchang√©)
    $("refreshExpenses").onclick = refreshExpenses;
    $("addExpenseBtn").onclick = addExpenseFromForm;
    $("clearExpenseFormBtn").onclick = () => { $("expAmount").value=""; $("expNote").value=""; $("expReceipt").value=""; $("expCategory").value="Parking"; $("expDate").value=isoDate(); };

    async function addExpenseFromForm() {
      const expense_date = $("expDate").value||isoDate(), amount_cents = toEuroStringToCents($("expAmount").value);
      const category = ($("expCategory").value||"").trim(), note = ($("expNote").value||"").trim()||null;
      const file = $("expReceipt").files?.[0]||null;
      if (!amount_cents||amount_cents<=0) { alert("Montant invalide."); return; }

      $("addExpenseBtn").disabled = true; setStatus("Ajout d√©pense‚Ä¶");
      let receipt_path = null;

      if (file) {
        const ext = (file.name.split(".").pop()||"jpg").toLowerCase();
        const safeExt = ext.replace(/[^a-z0-9]/g,"").slice(0,6)||"jpg";
        const path = `receipts/${expense_date}/${crypto.randomUUID()}.${safeExt}`;
        const up = await supabase.storage.from("receipts").upload(path, file, { upsert:false });
        if (up.error) { $("addExpenseBtn").disabled=false; setStatus(""); alert("Erreur upload: "+up.error.message); return; }
        receipt_path = path;
      }

      const ins = await supabase.from("expenses").insert({ expense_date, amount_cents, category, note, receipt_path });

      $("addExpenseBtn").disabled=false; setStatus("");
      if (ins.error) { alert("Erreur d√©pense: "+ins.error.message); return; }

      alert("D√©pense ajout√©e ‚úÖ"); $("expAmount").value=""; $("expNote").value=""; $("expReceipt").value="";
      await refreshExpenses(); await refreshResults();
    }

    async function refreshExpenses() {
      const from = $("expFrom").value||addDaysISO(isoDate(),-30), to = $("expTo").value||isoDate();
      setStatus("Chargement d√©penses‚Ä¶");
      const res = await supabase.from("expenses").select("id,expense_date,amount_cents,category,note,receipt_path,created_at").gte("expense_date",from).lte("expense_date",to).order("expense_date",{ascending:false}).order("created_at",{ascending:false});
      setStatus(""); if (res.error) { alert("Erreur: "+res.error.message); return; }

      const rows = res.data||[]; let total=0; for (const r of rows) total += Number(r.amount_cents||0);
      $("expTotal").textContent = eur(total);
      $("expList").innerHTML = renderExpensesTable(rows);

      for (const r of rows) {
        const delBtn = document.querySelector(`[data-exp-del="${r.id}"]`); if (delBtn) delBtn.onclick = () => deleteExpense(r.id, r.receipt_path);
        const viewBtn = document.querySelector(`[data-exp-view="${r.id}"]`); if (viewBtn) viewBtn.onclick = () => openReceipt(r.receipt_path);
      }
    }

    function renderExpensesTable(rows) {
      if (!rows.length) return `<div class="muted">Aucune d√©pense sur la p√©riode.</div>`;
      const trs = rows.map(r => `<tr>
        <td>${esc(r.expense_date)}</td><td>${esc(r.category)}</td>
        <td>${r.note?`<div>${esc(r.note)}</div>`:`<span class="muted">‚Äî</span>`}</td>
        <td style="white-space:nowrap;font-weight:900;">${eur(r.amount_cents)}</td>
        <td style="white-space:nowrap;">${r.receipt_path?`<button class="mini" data-exp-view="${r.id}" type="button">Voir</button>`:`<span class="muted">‚Äî</span>`} <button class="mini" data-exp-del="${r.id}" type="button">Suppr.</button></td>
      </tr>`).join("");
      return `<table><thead><tr><th>Date</th><th>Cat√©gorie</th><th>Note</th><th>Montant</th><th>Actions</th></tr></thead><tbody>${trs}</tbody></table>`;
    }

    async function openReceipt(path) {
      if (!path) return;
      const pub = supabase.storage.from("receipts").getPublicUrl(path);
      const url = pub?.data?.publicUrl;
      if (!url) { alert("Impossible d'ouvrir le scan."); return; }
      window.open(url, "_blank");
    }

    async function deleteExpense(id, receipt_path) {
      if (!confirm("Supprimer cette d√©pense ?")) return;
      setStatus("Suppression‚Ä¶");
      const del = await supabase.from("expenses").delete().eq("id", id);
      setStatus(""); if (del.error) { alert("Erreur: "+del.error.message); return; }
      if (receipt_path) await supabase.storage.from("receipts").remove([receipt_path]);
      await refreshExpenses(); await refreshResults();
    }

    // RESULTS (inchang√©)
    $("refreshResults").onclick = refreshResults;
    async function refreshResults() {
      const from = $("resFrom").value||addDaysISO(isoDate(),-30), to = $("resTo").value||isoDate();
      setStatus("Calcul r√©sultats‚Ä¶");

      const del = await supabase.from("deliveries").select("date_fabrication,product_id,qty_depose").gte("date_fabrication",from).lte("date_fabrication",to);
      const exp = await supabase.from("expenses").select("expense_date,amount_cents,category").gte("expense_date",from).lte("expense_date",to);

      setStatus("");
      if (del.error || exp.error) { alert("Erreur chargement r√©sultats"); return; }

      const prodByIdAll = Object.fromEntries(products.map(p=>[p.id,p]));
      let deliveredPieces=0, revenueCents=0;
      for (const r of (del.data||[])) { deliveredPieces+=Number(r.qty_depose||0); const p=prodByIdAll[r.product_id]; if (p) revenueCents+=Number(r.qty_depose||0)*Number(p.price_cents||0); }

      let expenseCents=0; const byCat=new Map();
      for (const r of (exp.data||[])) { const a=Number(r.amount_cents||0); expenseCents+=a; const c=String(r.category||"Divers"); byCat.set(c,(byCat.get(c)||0)+a); }

      $("resCA").textContent=eur(revenueCents); $("resExp").textContent=eur(expenseCents); $("resNet").textContent=eur(revenueCents-expenseCents);
      $("resPieces").textContent=`${deliveredPieces} pi√®ces livr√©es sur la p√©riode.`;

      const cats=Array.from(byCat.entries()).sort((a,b)=>b[1]-a[1]);
      $("resByCategory").innerHTML=!cats.length?`<div class="muted">Aucune d√©pense sur la p√©riode.</div>`
        :`<table><thead><tr><th>D√©penses par cat√©gorie</th><th style="text-align:right;">Total</th></tr></thead><tbody>${cats.map(([c,v])=>`<tr><td>${esc(c)}</td><td style="text-align:right;font-weight:900;">${eur(v)}</td></tr>`).join("")}</tbody></table>`;
    }

    // SETTINGS (inchang√©)
    $("saveSettings").onclick = saveSettingsLocal;
    $("btnAddLoc").onclick = addLocation;
    $("btnAddProd").onclick = addProduct;
    $("btnReloadAll").onclick = async () => { await reloadAllData(); };

    async function addLocation(){
      const name=$("newLocName").value.trim(), sort=toInt($("newLocSort").value,9999);
      if (!name) { alert("Nom du lieu obligatoire."); return; }
      setStatus("Ajout lieu‚Ä¶");
      const res = await supabase.from("locations").insert({ name, sort_order:sort, is_active:true });
      setStatus(""); if (res.error) { alert("Erreur: "+res.error.message); return; }
      $("newLocName").value=""; $("newLocSort").value=""; alert("Lieu ajout√© ‚úÖ"); await reloadAllData();
    }

    async function addProduct(){
      const name=$("newProdName").value.trim(), price_cents=toEuroStringToCents($("newProdPrice").value), sort=toInt($("newProdSort").value,9999);
      if (!name) { alert("Nom du sandwich obligatoire."); return; }
      if (price_cents===null) { alert("Prix invalide."); return; }
      setStatus("Ajout sandwich‚Ä¶");
      const res = await supabase.from("products").insert({ name, price_cents, sort_order:sort, is_active:true });
      setStatus(""); if (res.error) { alert("Erreur: "+res.error.message); return; }
      $("newProdName").value=""; $("newProdPrice").value=""; $("newProdSort").value=""; alert("Sandwich ajout√© ‚úÖ"); await reloadAllData();
    }

    async function setLocationActive(id, is_active){ setStatus("Mise √† jour‚Ä¶"); const res=await supabase.from("locations").update({is_active}).eq("id",id); setStatus(""); if (res.error){alert("Erreur: "+res.error.message);return;} await reloadAllData(); }
    async function setProductActive(id, is_active){ setStatus("Mise √† jour‚Ä¶"); const res=await supabase.from("products").update({is_active}).eq("id",id); setStatus(""); if (res.error){alert("Erreur: "+res.error.message);return;} await reloadAllData(); }

    async function updateLocation(id){
      const name=$("locName:"+id).value.trim(), sort=toInt($("locSort:"+id).value,9999);
      if (!name){alert("Nom obligatoire.");return;}
      setStatus("Sauvegarde‚Ä¶"); const res=await supabase.from("locations").update({name,sort_order:sort}).eq("id",id); setStatus(""); if (res.error){alert("Erreur: "+res.error.message);return;} await reloadAllData();
    }

    async function updateProduct(id){
      const name=$("prodName:"+id).value.trim(), sort=toInt($("prodSort:"+id).value,9999), price_cents=toEuroStringToCents($("prodPrice:"+id).value);
      if (!name){alert("Nom obligatoire.");return;} if (price_cents===null){alert("Prix invalide.");return;}
      setStatus("Sauvegarde‚Ä¶"); const res=await supabase.from("products").update({name,sort_order:sort,price_cents}).eq("id",id); setStatus(""); if (res.error){alert("Erreur: "+res.error.message);return;} await reloadAllData();
    }

    async function refreshSettingsLists(){
      const locHtml = locations.length
        ? locations.slice().sort((a,b)=>toInt(a.sort_order,9999)-toInt(b.sort_order,9999)).map(l=>`
            <div class="card" style="margin-top:10px;">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div style="font-weight:900;">${esc(l.name)}</div>
                ${l.is_active?"":` <span class="badgeOff">inactif</span>`}
                <div style="flex:1;"></div>
                <button class="mini" type="button" data-action="toggleLoc" data-id="${l.id}" data-active="${l.is_active?"1":"0"}">${l.is_active?"D√©sactiver":"Activer"}</button>
              </div>
              <div class="spacer"></div>
              <div class="grid2"><input id="locName:${l.id}" type="text" value="${esc(l.name)}" /><input id="locSort:${l.id}" type="number" value="${toInt(l.sort_order,9999)}" /></div>
              <button class="cta" type="button" data-action="saveLoc" data-id="${l.id}">Sauvegarder</button>
            </div>`).join("")
        : `<div class="muted">Aucun lieu.</div>`;

      const prodHtml = products.length
        ? products.slice().sort((a,b)=>toInt(a.sort_order,9999)-toInt(b.sort_order,9999)).map(p=>`
            <div class="card" style="margin-top:10px;">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div style="font-weight:900;">${esc(p.name)}</div>
                ${p.is_active?"":` <span class="badgeOff">inactif</span>`}
                <div class="muted">‚Äî <b>${eur(p.price_cents)}</b></div>
                <div style="flex:1;"></div>
                <button class="mini" type="button" data-action="toggleProd" data-id="${p.id}" data-active="${p.is_active?"1":"0"}">${p.is_active?"D√©sactiver":"Activer"}</button>
              </div>
              <div class="spacer"></div>
              <div class="grid2"><input id="prodName:${p.id}" type="text" value="${esc(p.name)}" /><input id="prodPrice:${p.id}" type="text" value="${(Number(p.price_cents||0)/100).toFixed(2).replace(".",",")}" /></div>
              <div class="spacer"></div>
              <input id="prodSort:${p.id}" type="number" value="${toInt(p.sort_order,9999)}" />
              <button class="cta" type="button" data-action="saveProd" data-id="${p.id}">Sauvegarder</button>
            </div>`).join("")
        : `<div class="muted">Aucun sandwich.</div>`;

      $("settingsLocList").innerHTML = locHtml;
      $("settingsProdList").innerHTML = prodHtml;

      $("settingsLocList").querySelectorAll("[data-action]").forEach(btn => {
        btn.onclick = async () => {
          const {action,id,active} = btn.dataset;
          if (action==="toggleLoc") await setLocationActive(id, active!=="1");
          if (action==="saveLoc") await updateLocation(id);
        };
      });
      $("settingsProdList").querySelectorAll("[data-action]").forEach(btn => {
        btn.onclick = async () => {
          const {action,id,active} = btn.dataset;
          if (action==="toggleProd") await setProductActive(id, active!=="1");
          if (action==="saveProd") await updateProduct(id);
        };
      });
    }

    // BOOT
    try {
      loadSettings();
      setStatus("Connect√© ‚úÖ");
      await reloadAllData();
      await refreshWithdraw();
      await refreshHistory();
      await refreshShiftKmSummary(); // ‚úÖ AJOUT
    } catch(e) {
      alert("Erreur init: " + (e?.message || e));
    }
  </script>
</body>
</html>
