<!doctype html>

<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Sandwich Ops</title>
  <style>
    :root { --pad: 14px; --border:#eee; --text:#111; --muted:rgba(17,17,17,.7); }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fff; color:var(--text); }
    * { -webkit-tap-highlight-color: transparent; }
    button, .btn, .pill, .navitem, .smallbtn, .mini { touch-action: manipulation; -webkit-user-select: none; user-select: none; }
    body { -webkit-user-select:none; user-select:none; }
    input, textarea, select { -webkit-user-select:text; user-select:text; }
    header { position: sticky; top:0; background:#fff; border-bottom:1px solid var(--border); padding: var(--pad); z-index: 5; display:flex; align-items:center; gap:10px; }
    h1 { font-size: 18px; margin:0; flex:1; }
    .muted { opacity:.7; font-size:13px; color:var(--text); }
    main { padding: var(--pad); max-width: 820px; margin: 0 auto; }
    .drawerOverlay { position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:20; display:none; }
    .drawer { position:fixed; left:0; top:0; bottom:0; width:300px; max-width:86vw; background:#fff; border-right:1px solid var(--border); z-index:21; transform: translateX(-100%); transition: transform .18s ease; padding: 12px; display:flex; flex-direction:column; gap:10px; }
    .drawer.open { transform: translateX(0); }
    .drawerOverlay.open { display:block; }
    .navtitle { font-weight:900; font-size:14px; margin-top:6px; }
    .navitem { width:100%; text-align:left; padding:12px; border-radius:14px; border:1px solid #ddd; background:#fff; font-weight:900; font-size:15px; }
    .navitem.active { background:#111; color:#fff; border-color:#111; }
    #logoutBtn { width:100%; text-align:left; padding:12px; border-radius:14px; border:1px solid #fcc; background:#fff8f8; color:#c00; font-weight:900; font-size:15px; touch-action:manipulation; -webkit-user-select:none; user-select:none; }
    .iconbtn { width:44px; height:40px; border-radius:12px; border:1px solid #ddd; background:#fff; font-size:18px; font-weight:900; }
    .card { padding: 12px; border:1px solid var(--border); border-radius: 14px; margin-top: 12px; }
    .row { display:flex; align-items:center; justify-content:space-between; padding: 12px; border:1px solid var(--border); border-radius: 14px; margin-bottom: 10px; gap:10px; }
    .name { font-weight: 900; }
    .sub { opacity:.7; font-size: 13px; margin-top:2px; }
    .qty { display:flex; align-items:center; gap:10px; }
    .btn { width: 46px; height: 40px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-size: 20px; font-weight: 900; }
    .qnum { min-width: 34px; text-align:center; font-size: 18px; font-weight: 900; }
    .kv { display:flex; justify-content:space-between; margin-top: 6px; }
    .cta { width:100%; padding: 14px; border-radius: 14px; border:none; background:#111; color:#fff; font-weight: 900; font-size: 16px; margin-top: 12px; }
    .cta:disabled { background:#888; }
    .smallbtn { padding: 10px 12px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-weight:900; }
    .mini { padding: 8px 10px; border-radius: 12px; border:1px solid #ddd; background:#fff; font-weight:900; font-size:13px; }
    input[type="date"], input[type="time"], select, input[type="number"], input[type="text"] { font-size: 16px; padding: 10px 12px; border-radius: 12px; border:1px solid #ddd; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .label { font-size: 12px; color: var(--muted); font-weight:700; }
    .pillrow { display:flex; gap:8px; flex-wrap:wrap; margin: 10px 0 12px 0; }
    .pill { padding: 10px 14px; border-radius: 999px; border:1px solid #ddd; background:#fff; font-weight:900; }
    .pill.active { background:#111; color:#fff; border-color:#111; }
    table { width:100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px 6px; text-align:left; font-size: 14px; vertical-align:top; }
    th { font-weight: 900; }
    tfoot td { font-weight:900; border-top: 2px solid #ddd; }
    .spacer { height:8px; }
    .section { display:none; }
    .section.active { display:block; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 720px){ .grid2 { grid-template-columns: 1fr; } }
    .badgeOff { display:inline-block; padding:4px 8px; border-radius:999px; border:1px solid #ddd; font-size:12px; opacity:.7; }
  </style>
</head>
<body>

  <div class="drawerOverlay" id="drawerOverlay"></div>
  <aside class="drawer" id="drawer">
    <div style="display:flex; align-items:center; gap:10px;">
      <div style="font-weight:900; font-size:16px;">Sandwich Ops</div>
      <div style="flex:1;"></div>
      <button class="iconbtn" id="closeDrawer">✕</button>
    </div>
    <div class="navtitle">Navigation</div>
    <button class="navitem" data-tab="today">Aujourd'hui</button>
    <button class="navitem" data-tab="delivery">Livraison</button>
    <button class="navitem" data-tab="withdraw">À retirer</button>
    <button class="navitem" data-tab="history">Historique</button>
    <button class="navitem" data-tab="expenses">Dépenses</button>
    <button class="navitem" data-tab="results">Résultats</button>
    <button class="navitem" data-tab="shifts">Shift</button>
    <button class="navitem" data-tab="km">KM</button>
    <button class="navitem" data-tab="settings">Paramètres</button>
    <div style="flex:1;"></div>
    <button id="logoutBtn">⎋ Déconnexion</button>
    <div class="muted">Astuce: change la date, choisis le lieu, "Charger depuis Supabase", modifie, puis "Enregistrer ce lieu".</div>
  </aside>

  <header>
    <button class="iconbtn" id="openDrawer">☰</button>
    <h1 id="title">Aujourd'hui</h1>
    <div class="muted" id="status"></div>
  </header>

  <main>
    <!-- ─── Onglet : Aujourd'hui ──────────────────────────────────────────── -->
    <section class="section active" id="tab-today">
      <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
        <div class="muted">Jour :</div>
        <input type="date" id="dayDate" />
        <button class="smallbtn" id="todayRefresh">Rafraîchir</button>
      </div>
      <div class="card" style="margin-top:12px;">
        <div style="font-weight:900;">À PRODUIRE (jour sélectionné)</div>
        <div class="muted">Basé sur ce qui est enregistré dans Supabase (deliveries).</div>
        <div class="spacer"></div>
        <div class="kv"><div>Total pièces</div><div id="todayPieces" style="font-weight:900;">0</div></div>
        <div class="kv"><div>Total €</div><div id="todayEur" style="font-weight:900;">0,00€</div></div>
        <div class="muted" style="margin-top:8px;">DLC 2 jours → Retrait à partir de J+3 (ex: fait le 18 → retirer le 21)</div>
        <div id="todayTable"></div>
      </div>
      <div class="card">
        <div style="font-weight:900;">Encoder rapidement</div>
        <div class="muted">Choisis un lieu → tu arrives sur Livraison (même date).</div>
        <div class="pillrow" id="quickLocPills"></div>
      </div>
      <div class="card">
        <div style="font-weight:900;">À retirer aujourd'hui (résumé)</div>
        <div class="muted">Basé sur la vue v_delivery_remaining (Supabase).</div>
        <div class="spacer"></div>
        <div id="todayWithdrawSummary" class="muted">-</div>
        <div class="spacer"></div>
        <button class="smallbtn" id="gotoWithdraw">Gérer les retraits</button>
      </div>
    </section>


<!-- ─── Onglet : Livraison ────────────────────────────────────────────── -->
<section class="section" id="tab-delivery">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <div class="muted">Jour :</div>
    <input type="date" id="delDate" />
    <button class="smallbtn" id="loadFromDBBtn">Charger depuis Supabase</button>
  </div>
  <div class="pillrow" id="locationPills"></div>
  <label class="muted" style="display:flex; align-items:center; gap:10px; margin:8px 0;">
    <input type="checkbox" id="hideZeros" checked /> Masquer les produits à 0
  </label>
  <div id="deliveryList"></div>
  <div class="card">
    <div class="kv"><div>Total pièces</div><div id="delTotalPieces" style="font-weight:900;">0</div></div>
    <div class="kv"><div>Total €</div><div id="delTotalEur" style="font-weight:900;">0,00€</div></div>
    <div class="muted" style="margin-top:8px;">Enregistrer ce lieu = remplace (jour + lieu) en base (anti-doublon).</div>
  </div>
  <button class="cta" id="saveLocationBtn">Enregistrer ce lieu</button>
</section>

<!-- ─── Onglet : À retirer ───────────────────────────────────────────── -->
<section class="section" id="tab-withdraw">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <div class="muted">Date :</div>
    <input type="date" id="withdrawDate" />
    <button class="smallbtn" id="refreshWithdraw">Rafraîchir</button>
  </div>
  <div style="display:flex; gap:8px; margin-top:10px;">
    <button class="smallbtn" id="btnWithdrawAll">Tout retirer</button>
    <button class="smallbtn" id="btnWithdrawNone">Rien retirer</button>
  </div>
  <div id="withdrawList"></div>
  <button class="cta" id="saveWithdrawBtn">Enregistrer les retraits</button>
</section>

<!-- ─── Onglet : Historique ──────────────────────────────────────────── -->
<section class="section" id="tab-history">
  <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
    <div class="muted">Du :</div><input type="date" id="histFrom" />
    <div class="muted">Au :</div><input type="date" id="histTo" />
    <button class="smallbtn" id="refreshHist">Filtrer</button>
  </div>
  <div class="card">
    <div class="kv"><div>Livré (pièces)</div><div id="histDelivered" style="font-weight:900;">0</div></div>
    <div class="kv"><div>Retiré (pièces)</div><div id="histWithdrawn" style="font-weight:900;">0</div></div>
    <div class="kv"><div>CA livré</div><div id="histRevenue" style="font-weight:900;">0,00€</div></div>
  </div>
  <div id="histList"></div>
</section>

<!-- ─── Onglet : Dépenses ────────────────────────────────────────────── -->
<section class="section" id="tab-expenses">
  <div class="card">
    <div style="font-weight:900;">Ajouter une dépense</div>
    <div class="muted">Scan facultatif (photo souche) → stocké dans Supabase Storage (bucket: receipts).</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <label class="field"><div class="label">Date</div><input type="date" id="expDate" /></label>
      <label class="field"><div class="label">Montant (€)</div><input type="text" inputmode="decimal" placeholder="ex: 12,50" id="expAmount" /></label>
      <label class="field">
        <div class="label">Catégorie</div>
        <select id="expCategory">
          <option value="Parking">Parking</option>
          <option value="Essence">Essence</option>
          <option value="Emballages">Emballages</option>
          <option value="Ingrédients">Ingrédients</option>
          <option value="Matériel">Matériel</option>
          <option value="Divers">Divers</option>
        </select>
      </label>
      <label class="field"><div class="label">Note (optionnel)</div><input type="text" placeholder="ex: parking 2h / facture Metro..." id="expNote" /></label>
      <label class="field" style="grid-column:1 / -1;"><div class="label">Scan / photo (optionnel)</div><input type="file" id="expReceipt" accept="image/*" /></label>
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;">
      <button class="smallbtn" id="addExpenseBtn">Ajouter</button>
      <button class="smallbtn" id="clearExpenseFormBtn">Vider</button>
    </div>
  </div>
  <div class="card">
    <div style="font-weight:900;">Journal des dépenses</div>
    <div class="muted">Filtre par dates (par défaut : 30 derniers jours).</div>
    <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
      <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="expFrom" /></label>
      <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="expTo" /></label>
      <button class="smallbtn" id="refreshExpenses">Rafraîchir</button>
    </div>
    <div class="spacer"></div>
    <div class="kv"><div>Total période</div><div id="expTotal" style="font-weight:900;">0,00€</div></div>
    <div id="expList" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ─── Onglet : Résultats ───────────────────────────────────────────── -->
<section class="section" id="tab-results">
  <div class="card">
    <div style="font-weight:900;">Résultats (CA - Dépenses)</div>
    <div class="muted">Basé sur deliveries (CA) et expenses (dépenses).</div>
    <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
      <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="resFrom" /></label>
      <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="resTo" /></label>
      <button class="smallbtn" id="refreshResults">Calculer</button>
    </div>
    <div class="spacer"></div>
    <div class="kv"><div>CA (livraisons)</div><div id="resCA" style="font-weight:900;">0,00€</div></div>
    <div class="kv"><div>Dépenses</div><div id="resExp" style="font-weight:900;">0,00€</div></div>
    <div class="kv"><div>Bénéfice net</div><div id="resNet" style="font-weight:900;">0,00€</div></div>
    <div class="muted" style="margin-top:10px;" id="resPieces">-</div>
    <div id="resByCategory" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ─── Onglet : Shift ───────────────────────────────────────────────── -->
<section class="section" id="tab-shifts">
  <div class="card">
    <div style="font-weight:900;">Ajouter un shift</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <label class="field"><div class="label">Date</div><input type="date" id="shiftDate" /></label>
      <label class="field"><div class="label">Note (optionnel)</div><input type="text" id="shiftNote" placeholder="ex: Avia + Leclerc" /></label>
      <label class="field"><div class="label">Heure début</div><input type="time" id="shiftStart" /></label>
      <label class="field"><div class="label">Heure fin</div><input type="time" id="shiftEnd" /></label>
    </div>
    <button class="cta" id="addShiftBtn">Ajouter le shift</button>
  </div>
  <div class="card">
    <div style="font-weight:900;">Journal des shifts</div>
    <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
      <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="shiftFrom" /></label>
      <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="shiftTo" /></label>
      <button class="smallbtn" id="refreshShifts">Rafraîchir</button>
    </div>
    <div class="spacer"></div>
    <div class="kv"><div>Total heures</div><div id="shiftTotal" style="font-weight:900;">0h00</div></div>
    <div id="shiftList" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ─── Onglet : KM ──────────────────────────────────────────────────── -->
<section class="section" id="tab-km">
  <div class="card">
    <div style="font-weight:900;">Ajouter un trajet</div>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
      <label class="field"><div class="label">Date</div><input type="date" id="kmDate" /></label>
      <label class="field"><div class="label">Taux (€/km, ex: 0,42)</div><input type="text" id="kmRate" placeholder="0,42" /></label>
      <label class="field"><div class="label">Km départ</div><input type="number" id="kmStart" placeholder="ex: 45000" /></label>
      <label class="field"><div class="label">Km arrivée</div><input type="number" id="kmEnd" placeholder="ex: 45087" /></label>
      <label class="field" style="grid-column:1/-1;"><div class="label">Note (optionnel)</div><input type="text" id="kmNote" placeholder="ex: tournée Avia + Leclerc" /></label>
    </div>
    <button class="cta" id="addKmBtn">Ajouter le trajet</button>
  </div>
  <div class="card">
    <div style="font-weight:900;">Journal kilométrique</div>
    <div style="display:flex; gap:8px; align-items:end; flex-wrap:wrap; margin-top:10px;">
      <label class="field" style="min-width:160px;"><div class="label">Du</div><input type="date" id="kmFrom" /></label>
      <label class="field" style="min-width:160px;"><div class="label">Au</div><input type="date" id="kmTo" /></label>
      <button class="smallbtn" id="refreshKm">Rafraîchir</button>
    </div>
    <div class="spacer"></div>
    <div class="kv"><div>Total km</div><div id="kmTotal" style="font-weight:900;">0 km</div></div>
    <div class="kv"><div>Remboursement estimé</div><div id="kmReimb" style="font-weight:900;">0,00€</div></div>
    <div id="kmList" style="margin-top:10px;"></div>
  </div>
</section>

<!-- ─── Onglet : Paramètres ──────────────────────────────────────────── -->
<section class="section" id="tab-settings">
  <div class="card">
    <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
      <div style="font-weight:900;">Paramètres</div>
      <div style="flex:1;"></div>
      <button class="mini" id="btnReloadAll">Recharger</button>
    </div>
    <div class="muted">Ici tu gères: DLC / J+ retrait + lieux + sandwichs (activer/désactiver, ordre, prix).</div>
  </div>
  <div class="card">
    <div style="font-weight:900; margin-bottom:6px;">DLC & Retrait</div>
    <div class="row" style="margin-bottom:0;">
      <div><div class="name">DLC</div><div class="sub">En jours</div></div>
      <div><input type="number" id="setDlc" value="2" style="width:110px;"></div>
    </div>
    <div class="row" style="margin-top:10px;">
      <div><div class="name">Retrait à partir de</div><div class="sub">J + ...</div></div>
      <div><input type="number" id="setWithdrawJ" value="3" style="width:110px;"></div>
    </div>
    <button class="cta" id="saveSettings">Sauvegarder (local)</button>
  </div>
  <div class="grid2">
    <div class="card">
      <div style="font-weight:900;">Ajouter un lieu</div>
      <div class="spacer"></div>
      <input id="newLocName" type="text" placeholder="Nom du lieu (ex: Avia)" />
      <div class="spacer"></div>
      <input id="newLocSort" type="number" placeholder="Ordre (ex: 10)" />
      <button class="cta" id="btnAddLoc">Ajouter lieu</button>
      <div class="spacer"></div>
      <div style="font-weight:900;">Lieux (actifs & inactifs)</div>
      <div class="muted">Tu peux modifier nom/ordre et activer/désactiver.</div>
      <div class="spacer"></div>
      <div id="settingsLocList" class="muted">-</div>
    </div>
    <div class="card">
      <div style="font-weight:900;">Ajouter un sandwich</div>
      <div class="spacer"></div>
      <input id="newProdName" type="text" placeholder="Nom (ex: Merguez)" />
      <div class="spacer"></div>
      <input id="newProdPrice" type="text" placeholder="Prix € (ex: 6,50)" />
      <div class="spacer"></div>
      <input id="newProdSort" type="number" placeholder="Ordre (ex: 10)" />
      <button class="cta" id="btnAddProd">Ajouter sandwich</button>
      <div class="spacer"></div>
      <div style="font-weight:900;">Sandwichs (actifs & inactifs)</div>
      <div class="muted">Modifier nom/prix/ordre et activer/désactiver.</div>
      <div class="spacer"></div>
      <div id="settingsProdList" class="muted">-</div>
    </div>
  </div>
</section>


  </main>

  <script type="module" src="./js/app.js"></script>

</body>
</html>
